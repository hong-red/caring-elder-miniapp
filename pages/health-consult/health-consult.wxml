<!-- pages/ai-chat/ai-chat.wxml -->
<navigation-bar 
  back="{{true}}" 
  color="white" 
  background="linear-gradient(135deg, #0066FF, #0052CC)"
>
  <view slot="center" class="header-title">
    <view class="main-title-row">
      <text class="main-title" bindtap="readText" data-text="AI å¥åº·ç®¡å®¶">AI å¥åº·ç®¡å®¶</text>
      <text class="title-badge" bindtap="readText" data-text="å®˜æ–¹">å®˜æ–¹</text>
    </view>
    <view class="online-status">
      <view class="status-dot-blink"></view>
      <text bindtap="readText" data-text="æ™ºèƒ½æœºå™¨äºº 24h å®ˆæŠ¤ä¸­">æ™ºèƒ½æœºå™¨äºº 24h å®ˆæŠ¤ä¸­</text>
    </view>
  </view>
</navigation-bar>

<view class="health-consult-container {{settings.bigFont ? 'big-font' : ''}} {{settings.highContrast ? 'high-contrast' : ''}}">

  <!-- å¯¼èˆªå ä½ï¼ˆé˜²æ­¢å†…å®¹è¢«æŒ¡ï¼‰ -->
  <view class="nav-placeholder" style="height: 14rpx; display: block; box-sizing: border-box"></view>

  <!-- æ»šåŠ¨èŠå¤©åŒº -->
  <scroll-view 
    class="scrollarea message-list" 
    scroll-y 
    scroll-with-animation 
    scroll-top="{{scrollTop}}" 
    scroll-into-view="{{scrollIntoView}}" 
    bindscrolltolower="loadMoreMessages"
    enable-back-to-top
   style="height: 1079rpx; display: block; box-sizing: content-box; left: 0rpx; top: 0rpx">
    <view class="message-wrapper" style="height: 1199rpx; display: flex; box-sizing: border-box">

      <!-- æ¬¢è¿å¼•å¯¼å¡ç‰‡ï¼ˆä»…åœ¨å®Œå…¨ç©ºèŠå¤©æ—¶æ˜¾ç¤ºï¼‰ --> 
      <view class="welcome-section" wx:if="{{messages.length === 0 && !loading}}">
        <view class="welcome-card card shadow-normal">
          <view class="welcome-header">
            <view class="bot-icon-wrap">
              <view class="bot-text-icon">æ™º</view>
              <view class="bot-status-ring"></view>
            </view>
            <view class="welcome-title-box">
              <text class="welcome-title">æ‚¨å¥½ï¼Œæˆ‘æ˜¯å°æ™º</text>
              <text class="welcome-subtitle">æ‚¨çš„å…¨èƒ½å¥åº·ç”Ÿæ´»åŠ©æ‰‹</text>
            </view>
          </view>

          <view class="welcome-body">
            <text class="welcome-desc">æ‚¨å¯ä»¥é—®æˆ‘ï¼š</text>
            <view class="guide-list">
              <view class="guide-item" bindtap="sendQuickQuestion" data-question="æˆ‘ç°åœ¨çš„è¡€å‹æ­£å¸¸å—ï¼Ÿ">
                <text class="guide-dot">Â·</text>
                <text>åˆ†ææˆ‘çš„æœ€æ–°å¥åº·æ•°æ®</text>
                <text class="guide-arrow">></text>
              </view>
              <view class="guide-item" bindtap="sendQuickQuestion" data-question="å¿ƒæƒ…ä¸å¥½è¯¥æ€ä¹ˆè°ƒèŠ‚ï¼Ÿ">
                <text class="guide-dot">Â·</text>
                <text>å¯»æ±‚å¿ƒç†æ…°è—‰ä¸å»ºè®®</text>
                <text class="guide-arrow">></text>
              </view>
              <view class="guide-item" bindtap="sendQuickQuestion" data-question="é€‚åˆè€å¹´äººçš„è¿åŠ¨æœ‰å“ªäº›ï¼Ÿ">
                <text class="guide-dot">Â·</text>
                <text>äº†è§£ç”Ÿæ´»å…»ç”Ÿå°çŸ¥è¯†</text>
                <text class="guide-arrow">></text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- AI æ€è€ƒåŠ¨ç”»æ”¾æ¶ˆæ¯åˆ—è¡¨é¡¶éƒ¨ --> 
      <view class="ai-thinking" wx:if="{{loading}}">
        <view class="thinking-bubble">
          <view class="dot-flashing">
            <view class="dot"></view>
            <view class="dot"></view>
            <view class="dot"></view>
          </view>
          <text class="thinking-text">å°æ™ºæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆå¥åº·æŠ¥å‘Š...</text>
        </view>
      </view>

      <!-- æ¶ˆæ¯åˆ—è¡¨ --> 
      <block wx:for="{{messages}}" wx:key="id">
        <view 
          class="message-item {{item.type === 'user' ? 'user-item' : 'ai-item'}}" 
          id="msg-{{item.id}}"
        >
          <!-- AI å¤´åƒ -->
          <view class="message-avatar ai-avatar" wx:if="{{item.type === 'ai'}}">
            <view class="avatar-inner">æ™º</view>
          </view>

          <!-- æ¶ˆæ¯æ°”æ³¡ + æ—¶é—´ -->
          <view class="message-content">
            <view 
              class="message-bubble" 
              bindtap="readMessage" 
              data-text="{{item.content}}"
              data-msg-id="{{item.id}}"
            >
              <text>{{item.content}}</text>
            </view>
            <view class="message-time">{{item.timestamp}}</view>
          </view>

          <!-- ç”¨æˆ·å¤´åƒ -->
          <view class="message-avatar user-avatar" wx:if="{{item.type === 'user'}}">
            <view class="avatar-inner">æˆ‘</view>
          </view>
        </view>
      </block>

      <!-- åº•éƒ¨é”šç‚¹ï¼ˆç”¨äºè‡ªåŠ¨æ»šåˆ°åº•éƒ¨ï¼‰ -->
      <view id="bottom-anchor"></view>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨å›ºå®šæ“ä½œåŒº -->
  <view class="bottom-area">

    <!-- å¿«æ·é—®é¢˜æ¨ªå‘æ»šåŠ¨ -->
    <view class="quick-questions-panel" wx:if="{{quickQuestions.length > 0}}" style="height: 193rpx; display: block; box-sizing: border-box">
      <view class="quick-header">
        <text class="quick-title">çŒœæ‚¨æƒ³é—®</text>
        <view class="quick-line"></view>
      </view>
      <scroll-view class="quick-questions" scroll-x show-scrollbar="{{false}}" style="height: 66rpx; display: block; box-sizing: border-box">
        <view class="quick-question-item" 
          wx:for="{{quickQuestions}}" 
          wx:key="index" 
          bindtap="sendQuickQuestion" 
          data-question="{{item}}"
         style="height: 60rpx; display: inline-block; box-sizing: border-box">
          <text class="quick-text">{{item}}</text>
        </view>
      </scroll-view>
    </view>

    <!-- å¥åº·æ•°æ®æŠ˜å æ¡ --> 
    <view 
      class="health-summary-bar compact {{showHealthData ? 'expanded' : ''}}" 
      wx:if="{{currentHealthData}}" 
      bindtap="toggleHealthData" 
    > 
      <view class="summary-header"> 
        <text class="summary-icon">ğŸ“Š</text> 
        <text class="summary-title">æœ€æ–°å¥åº·è®°å½•ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</text> 
        <text class="toggle-icon">{{showHealthData ? 'æ”¶èµ·' : 'å±•å¼€'}}</text> 
      </view> 

      <view class="health-data-grid" wx:if="{{showHealthData}}"> 
        <view class="data-card"> 
          <text class="data-label">è„‰æ</text> 
          <text class="data-val">{{currentHealthData.pulse || '--'}}<text class="data-unit">bpm</text></text> 
        </view> 
        <view class="data-card"> 
          <text class="data-label">å¿ƒç‡</text> 
          <text class="data-val">{{currentHealthData.heartRate || '--'}}<text class="data-unit">bpm</text></text> 
        </view> 
        <view class="data-card"> 
          <text class="data-label">è¡€å‹</text> 
          <text class="data-val">{{currentHealthData.systolic || '--'}}/{{currentHealthData.diastolic || '--'}}<text class="data-unit">mmHg</text></text> 
        </view> 
      </view> 
    </view>

    <!-- è¾“å…¥åŒº -->
    <view class="input-panel-container">
      <view class="input-panel">
        <view class="input-content-wrap">
          <input 
            class="input-field" 
            placeholder="ç‚¹å‡»è¾“å…¥å†…å®¹..." 
            value="{{inputMessage}}" 
            bindinput="onInputChange" 
            confirm-type="send" 
            bindconfirm="sendMessage" 
            placeholder-class="input-placeholder"
          />
        </view>
        <button 
          class="send-btn {{inputMessage.trim() ? 'active' : ''}}" 
          bindtap="sendMessage"
          disabled="{{!inputMessage.trim()}}"
        >
          å‘é€
        </button>
      </view>
    </view>
  </view>

  <!-- æ‚¬æµ®æœ—è¯»æŒ‰é’®ï¼ˆå¯æ‹–åŠ¨ï¼‰ -->
  
</view>
